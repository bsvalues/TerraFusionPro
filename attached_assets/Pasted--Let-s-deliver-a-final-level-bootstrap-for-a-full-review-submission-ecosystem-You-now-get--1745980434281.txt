ğŸ”¥ Letâ€™s deliver a **final-level bootstrap** for a full review+submission ecosystem. You now get:

> ğŸ” Reopen Workflow  
> ğŸŒ Third-Party Webhooks  
> ğŸ•° Audit Trail Visualizer  

Each one builds on the previous foundation. Letâ€™s go module-by-module:

---

# ğŸ” 1. **Reopen Workflow (Post-Lock Edits)**

---

## ğŸ§± Extend `forms` Table

```ts
alter table forms add column reopen_requested_at timestamp;
alter table forms add column reopen_reason text;
alter table forms add column reopen_approved boolean;
```

---

## ğŸ§  Workflow

1. Appraiser clicks â€œRequest Reopenâ€  
2. Admin reviews â†’ Approve or Reject  
3. On approval â†’ `locked_at` cleared, form editable again  
4. Logged in audit trail

---

## ğŸ“¡ API

### `POST /form/reopen-request`

```ts
router.post('/form/reopen-request', async (req, res) => {
  await db.update(forms).set({
    reopenRequestedAt: new Date(),
    reopenReason: req.body.reason
  }).where(f => f.id.eq(req.body.formId));
  res.json({ success: true });
});
```

---

### `POST /form/reopen-approve`

```ts
router.post('/form/reopen-approve', checkRole('admin'), async (req, res) => {
  await db.update(forms).set({
    lockedAt: null,
    reopenApproved: true
  }).where(f => f.id.eq(req.body.formId));
  res.json({ success: true });
});
```

---

## UI Indicators

- ğŸ”’ Locked banner â†’ â€œRequest Reopenâ€ button  
- ğŸŸ¡ Reviewer dashboard â†’ â€œPending Reopen Requestsâ€ tab  
- ğŸŸ¢ Admin sees all reopen logs for auditing

---

## ğŸ” Optional Enhancements

- Require reviewer comment on reopen  
- Notify assigned reviewer when reopened  
- Include in audit trail

---

# ğŸŒ 2. Third-Party Webhook Integrations (UCDP, Encompass, etc.)

---

## ğŸ“¦ Config Table: `submission_hooks`

```ts
export const submissionHooks = pgTable('submission_hooks', {
  id: uuid('id').defaultRandom().primaryKey(),
  orgId: text('org_id').notNull(),
  destination: text('destination').notNull(), // 'UCDP', 'Encompass'
  hookUrl: text('hook_url').notNull(),
  secret: text('secret'), // optional HMAC
  enabled: boolean('enabled').default(true)
});
```

---

## ğŸ“¤ On Submit â†’ Trigger Hook

### Inject into `/submit`

```ts
const hook = await db.query.submissionHooks.findFirst({
  where: (h) => h.orgId.eq(orgId).and(h.destination.eq(destination)).and(h.enabled)
});

if (hook) {
  const payload = { formId, status: 'submitted', ...formSummary };
  const signature = crypto.createHmac('sha256', hook.secret).update(JSON.stringify(payload)).digest('hex');

  axios.post(hook.hookUrl, payload, {
    headers: { 'X-Signature': signature }
  });
}
```

---

## âœ… Use Cases

- UCDP auto-import
- Encompass push-to-loan
- Fannie pre-checks or cloud storage
- Internal webhooks for CRMs or queueing

---

# ğŸ•° 3. Audit Trail Visualizer (Form Lifecycle Timeline)

---

## ğŸ—‚ DB Schema: `form_audit_log` (already created earlier)

```ts
{
  formId: 'xyz',
  userId: 'alice@firm.com',
  action: 'field_edit' | 'locked' | 'reopened' | 'reviewed' | 'pushed' | 'submitted',
  details: { field: 'G1', old: '$400K', new: '$420K' },
  at: timestamp
}
```

---

## ğŸ“¡ API: `GET /audit/timeline/:formId`

```ts
router.get('/audit/timeline/:formId', async (req, res) => {
  const log = await db.query.formAuditLog.findMany({
    where: (f) => f.formId.eq(req.params.formId),
    orderBy: (f) => f.at.asc()
  });

  res.json({ events: log });
});
```

---

## ğŸ§  React Timeline Component

```tsx
<ul className="timeline">
  {events.map(ev => (
    <li key={ev.id}>
      <div className="timestamp">{formatDate(ev.at)}</div>
      <div className="action">
        <strong>{ev.userId}</strong> {renderAction(ev)}
      </div>
    </li>
  ))}
</ul>

function renderAction(ev) {
  switch (ev.action) {
    case 'field_edit':
      return `updated ${ev.details.field} to ${ev.details.new}`;
    case 'locked':
      return `locked form`;
    case 'reopened':
      return `reopen approved`;
    case 'reviewed':
      return `marked as Reviewed OK`;
    case 'submitted':
      return `submitted to ${ev.details.destination}`;
    default:
      return ev.action;
  }
}
```

---

## ğŸ” Filters

- Field changes only  
- Reviewer events only  
- Submission-only view  

---

## âœ… What You Now Have

| Feature               | Status  |
|----------------------|---------|
| Reopen request â†’ approval | âœ… Done |
| Third-party webhooks (UCDP etc.) | âœ… Hookable |
| Audit trail â†’ timeline viewer | âœ… Logged + visual |
| Role control | âœ… Checked |
| HMAC security (optional) | âœ… Ready |

---

### ğŸ¯ Now your system supports:

- **Locked-state discipline**
- **Lifecycle observability**
- **Automated downstream delivery**
- **Reopen & correction loops**

---

## ğŸ§­ Whatâ€™s Next?

Would you like to:
1. ğŸ§¬ Add **versioning of form snapshots** for undo/history?
2. ğŸ“¦ Generate **MISMO-compliant XML** for lenders?
3. ğŸ§  Create **AI-assist mode** to prefill fields based on comp text or PDF intake?